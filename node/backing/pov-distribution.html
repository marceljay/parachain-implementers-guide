<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>PoV Distribution - The Polkadot Parachain Host Implementers' Guide</title>
        
        


        <!-- Custom HTML head -->
        


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        
        <link rel="icon" href="../../favicon.svg">
        
        
        <link rel="shortcut icon" href="../../favicon.png">
        
        <link rel="stylesheet" href="../../css/variables.css">
        <link rel="stylesheet" href="../../css/general.css">
        <link rel="stylesheet" href="../../css/chrome.css">
        
        <link rel="stylesheet" href="../../css/print.css" media="print">
        

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="../../fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../highlight.css">
        <link rel="stylesheet" href="../../tomorrow-night.css">
        <link rel="stylesheet" href="../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../../index.html">Preamble</a></li><li class="chapter-item expanded "><a href="../../whence-parachains.html"><strong aria-hidden="true">1.</strong> Whence Parachains</a></li><li class="chapter-item expanded "><a href="../../protocol-overview.html"><strong aria-hidden="true">2.</strong> Protocol Overview</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../protocol-approval.html"><strong aria-hidden="true">2.1.</strong> Approval Process</a></li></ol></li><li class="chapter-item expanded "><a href="../../architecture.html"><strong aria-hidden="true">3.</strong> Architecture Overview</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../messaging.html"><strong aria-hidden="true">3.1.</strong> Messaging Overview</a></li></ol></li><li class="chapter-item expanded "><a href="../../runtime/index.html"><strong aria-hidden="true">4.</strong> Runtime Architecture</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../runtime/initializer.html"><strong aria-hidden="true">4.1.</strong> Initializer Module</a></li><li class="chapter-item expanded "><a href="../../runtime/configuration.html"><strong aria-hidden="true">4.2.</strong> Configuration Module</a></li><li class="chapter-item expanded "><a href="../../runtime/disputes.html"><strong aria-hidden="true">4.3.</strong> Disputes Module</a></li><li class="chapter-item expanded "><a href="../../runtime/paras.html"><strong aria-hidden="true">4.4.</strong> Paras Module</a></li><li class="chapter-item expanded "><a href="../../runtime/scheduler.html"><strong aria-hidden="true">4.5.</strong> Scheduler Module</a></li><li class="chapter-item expanded "><a href="../../runtime/inclusion.html"><strong aria-hidden="true">4.6.</strong> Inclusion Module</a></li><li class="chapter-item expanded "><a href="../../runtime/inclusioninherent.html"><strong aria-hidden="true">4.7.</strong> InclusionInherent Module</a></li><li class="chapter-item expanded "><a href="../../runtime/dmp.html"><strong aria-hidden="true">4.8.</strong> DMP Module</a></li><li class="chapter-item expanded "><a href="../../runtime/ump.html"><strong aria-hidden="true">4.9.</strong> UMP Module</a></li><li class="chapter-item expanded "><a href="../../runtime/hrmp.html"><strong aria-hidden="true">4.10.</strong> HRMP Module</a></li><li class="chapter-item expanded "><a href="../../runtime/session_info.html"><strong aria-hidden="true">4.11.</strong> Session Info Module</a></li></ol></li><li class="chapter-item expanded "><a href="../../runtime-api/index.html"><strong aria-hidden="true">5.</strong> Runtime APIs</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../runtime-api/validators.html"><strong aria-hidden="true">5.1.</strong> Validators</a></li><li class="chapter-item expanded "><a href="../../runtime-api/validator-groups.html"><strong aria-hidden="true">5.2.</strong> Validator Groups</a></li><li class="chapter-item expanded "><a href="../../runtime-api/availability-cores.html"><strong aria-hidden="true">5.3.</strong> Availability Cores</a></li><li class="chapter-item expanded "><a href="../../runtime-api/persisted-validation-data.html"><strong aria-hidden="true">5.4.</strong> Persisted Validation Data</a></li><li class="chapter-item expanded "><a href="../../runtime-api/full-validation-data.html"><strong aria-hidden="true">5.5.</strong> Full Validation Data</a></li><li class="chapter-item expanded "><a href="../../runtime-api/session-index.html"><strong aria-hidden="true">5.6.</strong> Session Index</a></li><li class="chapter-item expanded "><a href="../../runtime-api/validation-code.html"><strong aria-hidden="true">5.7.</strong> Validation Code</a></li><li class="chapter-item expanded "><a href="../../runtime-api/candidate-pending-availability.html"><strong aria-hidden="true">5.8.</strong> Candidate Pending Availability</a></li><li class="chapter-item expanded "><a href="../../runtime-api/candidate-events.html"><strong aria-hidden="true">5.9.</strong> Candidate Events</a></li></ol></li><li class="chapter-item expanded "><a href="../../node/index.html"><strong aria-hidden="true">6.</strong> Node Architecture</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../node/subsystems-and-jobs.html"><strong aria-hidden="true">6.1.</strong> Subsystems and Jobs</a></li><li class="chapter-item expanded "><a href="../../node/overseer.html"><strong aria-hidden="true">6.2.</strong> Overseer</a></li><li class="chapter-item expanded "><a href="../../node/collators/index.html"><strong aria-hidden="true">6.3.</strong> Collators</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../node/collators/collation-generation.html"><strong aria-hidden="true">6.3.1.</strong> Collation Generation</a></li><li class="chapter-item expanded "><a href="../../node/collators/collator-protocol.html"><strong aria-hidden="true">6.3.2.</strong> Collator Protocol</a></li></ol></li><li class="chapter-item expanded "><a href="../../node/backing/index.html"><strong aria-hidden="true">6.4.</strong> Backing Subsystems</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../node/backing/candidate-selection.html"><strong aria-hidden="true">6.4.1.</strong> Candidate Selection</a></li><li class="chapter-item expanded "><a href="../../node/backing/candidate-backing.html"><strong aria-hidden="true">6.4.2.</strong> Candidate Backing</a></li><li class="chapter-item expanded "><a href="../../node/backing/statement-distribution.html"><strong aria-hidden="true">6.4.3.</strong> Statement Distribution</a></li><li class="chapter-item expanded "><a href="../../node/backing/pov-distribution.html" class="active"><strong aria-hidden="true">6.4.4.</strong> PoV Distribution</a></li></ol></li><li class="chapter-item expanded "><a href="../../node/availability/index.html"><strong aria-hidden="true">6.5.</strong> Availability Subsystems</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../node/availability/availability-distribution.html"><strong aria-hidden="true">6.5.1.</strong> Availability Distribution</a></li><li class="chapter-item expanded "><a href="../../node/availability/availability-recovery.html"><strong aria-hidden="true">6.5.2.</strong> Availability Recovery</a></li><li class="chapter-item expanded "><a href="../../node/availability/bitfield-distribution.html"><strong aria-hidden="true">6.5.3.</strong> Bitfield Distribution</a></li><li class="chapter-item expanded "><a href="../../node/availability/bitfield-signing.html"><strong aria-hidden="true">6.5.4.</strong> Bitfield Signing</a></li></ol></li><li class="chapter-item expanded "><a href="../../node/approval/index.html"><strong aria-hidden="true">6.6.</strong> Approval Subsystems</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../node/approval/approval-voting.html"><strong aria-hidden="true">6.6.1.</strong> Approval Voting</a></li><li class="chapter-item expanded "><a href="../../node/approval/approval-distribution.html"><strong aria-hidden="true">6.6.2.</strong> Approval Distribution</a></li><li class="chapter-item expanded "><a href="../../node/approval/dispute-participation.html"><strong aria-hidden="true">6.6.3.</strong> Dispute Participation</a></li></ol></li><li class="chapter-item expanded "><a href="../../node/utility/index.html"><strong aria-hidden="true">6.7.</strong> Utility Subsystems</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../node/utility/availability-store.html"><strong aria-hidden="true">6.7.1.</strong> Availability Store</a></li><li class="chapter-item expanded "><a href="../../node/utility/candidate-validation.html"><strong aria-hidden="true">6.7.2.</strong> Candidate Validation</a></li><li class="chapter-item expanded "><a href="../../node/utility/provisioner.html"><strong aria-hidden="true">6.7.3.</strong> Provisioner</a></li><li class="chapter-item expanded "><a href="../../node/utility/network-bridge.html"><strong aria-hidden="true">6.7.4.</strong> Network Bridge</a></li><li class="chapter-item expanded "><a href="../../node/utility/misbehavior-arbitration.html"><strong aria-hidden="true">6.7.5.</strong> Misbehavior Arbitration</a></li><li class="chapter-item expanded "><a href="../../node/utility/peer-set-manager.html"><strong aria-hidden="true">6.7.6.</strong> Peer Set Manager</a></li><li class="chapter-item expanded "><a href="../../node/utility/runtime-api.html"><strong aria-hidden="true">6.7.7.</strong> Runtime API Requests</a></li><li class="chapter-item expanded "><a href="../../node/utility/chain-api.html"><strong aria-hidden="true">6.7.8.</strong> Chain API Requests</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../../types/index.html"><strong aria-hidden="true">7.</strong> Data Structures and Types</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../types/candidate.html"><strong aria-hidden="true">7.1.</strong> Candidate</a></li><li class="chapter-item expanded "><a href="../../types/backing.html"><strong aria-hidden="true">7.2.</strong> Backing</a></li><li class="chapter-item expanded "><a href="../../types/availability.html"><strong aria-hidden="true">7.3.</strong> Availability</a></li><li class="chapter-item expanded "><a href="../../types/overseer-protocol.html"><strong aria-hidden="true">7.4.</strong> Overseer and Subsystem Protocol</a></li><li class="chapter-item expanded "><a href="../../types/runtime.html"><strong aria-hidden="true">7.5.</strong> Runtime</a></li><li class="chapter-item expanded "><a href="../../types/chain.html"><strong aria-hidden="true">7.6.</strong> Chain</a></li><li class="chapter-item expanded "><a href="../../types/messages.html"><strong aria-hidden="true">7.7.</strong> Messages</a></li><li class="chapter-item expanded "><a href="../../types/network.html"><strong aria-hidden="true">7.8.</strong> Network</a></li><li class="chapter-item expanded "><a href="../../types/approval.html"><strong aria-hidden="true">7.9.</strong> Approvals</a></li></ol></li><li class="chapter-item expanded "><a href="../../glossary.html">Glossary</a></li><li class="chapter-item expanded affix "><a href="../../further-reading.html">Further Reading</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">The Polkadot Parachain Host Implementers' Guide</h1>

                    <div class="right-buttons">
                        
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                        
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1><a class="header" href="#pov-distribution" id="pov-distribution">PoV Distribution</a></h1>
<p>This subsystem is responsible for distributing PoV blocks. For now, unified with <a href="statement-distribution.html">Statement Distribution subsystem</a>.</p>
<h2><a class="header" href="#protocol" id="protocol">Protocol</a></h2>
<p><code>PeerSet</code>: <code>Validation</code></p>
<p>Input: <a href="../../types/overseer-protocol.html#pov-distribution-message"><code>PoVDistributionMessage</code></a></p>
<p>Output:</p>
<ul>
<li>NetworkBridge::SendMessage(<code>[PeerId]</code>, message)</li>
<li>NetworkBridge::ReportPeer(PeerId, cost_or_benefit)</li>
</ul>
<h2><a class="header" href="#functionality" id="functionality">Functionality</a></h2>
<p>This network protocol is responsible for distributing <a href="../../types/availability.html#proof-of-validity"><code>PoV</code>s</a> by gossip. Since PoVs are heavy in practice, gossip is far from the most efficient way to distribute them. In the future, this should be replaced by a better network protocol that finds validators who have validated the block and connects to them directly. This protocol is described.</p>
<p>This protocol is described in terms of &quot;us&quot; and our peers, with the understanding that this is the procedure that any honest node will run. It has the following goals:</p>
<ul>
<li>We never have to buffer an unbounded amount of data</li>
<li>PoVs will flow transitively across a network of honest nodes, stemming from the validators that originally seconded candidates requiring those PoVs.</li>
</ul>
<p>As we are gossiping, we need to track which PoVs our peers are waiting for to avoid sending them data that they are not expecting. It is not reasonable to expect our peers to buffer unexpected PoVs, just as we will not buffer unexpected PoVs. So notifying our peers about what is being awaited is key. However it is important that the notifications system is also bounded.</p>
<p>For this, in order to avoid reaching into the internals of the <a href="statement-distribution.html">Statement Distribution</a> Subsystem, we can rely on an expected property of candidate backing: that each validator can second up to 2 candidates per chain head. This will typically be only one, because they are only supposed to issue one, but they can equivocate if they are willing to  be slashed. So we can set a cap on the number of PoVs each peer is allowed to notify us that they are waiting for at a given relay-parent. This cap will be twice the number of validators at that relay-parent. In practice, this is a very lax upper bound that can be reduced much further if desired.</p>
<p>The view update mechanism of the <a href="../utility/network-bridge.html">Network Bridge</a> ensures that peers are only allowed to consider a certain set of relay-parents as live. So this bounding mechanism caps the amount of data we need to store per peer at any time at <code>sum({ 2 * n_validators_at_head(head) * sizeof(hash) for head in view_heads })</code>. Additionally, peers should only be allowed to notify us of PoV hashes they are waiting for in the context of relay-parents in our own local view, which means that <code>n_validators_at_head</code> is implied to be <code>0</code> for relay-parents not in our own local view.</p>
<p>View updates from peers and our own view updates are received from the network bridge. These will lag somewhat behind the <code>ActiveLeavesUpdate</code> messages received from the overseer, which will influence the actual data we store. The <code>OurViewUpdate</code>s from the <a href="../../types/overseer-protocol.html#network-bridge-update"><code>NetworkBridgeEvent</code></a> must be considered canonical in terms of our peers' perception of us.</p>
<p>Lastly, the system needs to be bootstrapped with our own perception of which PoVs we are cognizant of but awaiting data for. This is done by receipt of the <a href="../../types/overseer-protocol.html#pov-distribution-message"><code>PoVDistributionMessage</code></a>::FetchPoV variant. Proper operation of this subsystem depends on the descriptors passed faithfully representing candidates which have been seconded by other validators.</p>
<h2><a class="header" href="#formal-description" id="formal-description">Formal Description</a></h2>
<p>This protocol can be implemented as a state machine with the following state:</p>
<pre><pre class="playground"><code class="language-rust">
<span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>struct State {
	relay_parent_state: Map&lt;Hash, BlockBasedState&gt;,
	peer_state: Map&lt;PeerId, PeerState&gt;,
	our_view: View,
}

struct BlockBasedState {
	known: Map&lt;Hash, PoV&gt;, // should be a shared PoV in practice. these things are heavy.
	fetching: Map&lt;Hash, [ResponseChannel&lt;PoV&gt;]&gt;,
	n_validators: usize,
}

struct PeerState {
	awaited: Map&lt;Hash, Set&lt;Hash&gt;&gt;,
}
<span class="boring">}
</span></code></pre></pre>
<p>We also use the <a href="../../types/network.html#pov-distribution"><code>PoVDistributionV1Message</code></a> as our <code>NetworkMessage</code>, which are sent and received by the <a href="../utility/network-bridge.html">Network Bridge</a></p>
<p>Here is the logic of the state machine:</p>
<p><em>Overseer Signals</em></p>
<ul>
<li>On <code>ActiveLeavesUpdate(relay_parent)</code>:
<ul>
<li>For each relay-parent in the <code>activated</code> list:
<ul>
<li>Get the number of validators at that relay parent by querying the <a href="../utility/runtime-api.html">Runtime API</a> for the validators and then counting them.</li>
<li>Create a blank entry in <code>relay_parent_state</code> under <code>relay_parent</code> with correct <code>n_validators</code> set.</li>
</ul>
</li>
<li>For each relay-parent in the <code>deactivated</code> list:
<ul>
<li>Remove the entry for <code>relay_parent</code> from <code>relay_parent_state</code>.</li>
</ul>
</li>
</ul>
</li>
<li>On <code>Conclude</code>: conclude.</li>
</ul>
<p><em>PoV Distribution Messages</em></p>
<ul>
<li>On <code>FetchPoV(relay_parent, descriptor, response_channel)</code>
<ul>
<li>If there is no entry in <code>relay_parent_state</code> under <code>relay_parent</code>, ignore.</li>
<li>If there is a PoV under <code>descriptor.pov_hash</code> in the <code>known</code> map, send that PoV on the channel and return.</li>
<li>Otherwise, place the <code>response_channel</code> in the <code>fetching</code> map under <code>descriptor.pov_hash</code>.</li>
<li>If the <code>pov_hash</code> had no previous entry in <code>fetching</code> and there are <code>2 * n_validators</code> or fewer entries in the <code>fetching</code> set, send <code>NetworkMessage::Awaiting(relay_parent, vec![pov_hash])</code> to all peers.</li>
</ul>
</li>
<li>On <code>DistributePoV(relay_parent, descriptor, PoV)</code>
<ul>
<li>If there is no entry in <code>relay_parent_state</code> under <code>relay_parent</code>, ignore.</li>
<li>Complete and remove any channels under <code>descriptor.pov_hash</code> in the <code>fetching</code> map.</li>
<li>Send <code>NetworkMessage::SendPoV(relay_parent, descriptor.pov_hash, PoV)</code> to all peers who have the <code>descriptor.pov_hash</code> in the set under <code>relay_parent</code> in the <code>peer.awaited</code> map and remove the entry from <code>peer.awaited</code>.</li>
<li>Note the PoV under <code>descriptor.pov_hash</code> in <code>known</code>.</li>
</ul>
</li>
</ul>
<p><em>Network Bridge Updates</em></p>
<ul>
<li>On <code>PeerConnected(peer_id, observed_role)</code>
<ul>
<li>Make a fresh entry in the <code>peer_state</code> map for the <code>peer_id</code>.</li>
</ul>
</li>
<li>On <code>PeerDisconnected(peer_id)</code>
<ul>
<li>Remove the entry for <code>peer_id</code> from the <code>peer_state</code> map.</li>
</ul>
</li>
<li>On <code>PeerMessage(peer_id, bytes)</code>
<ul>
<li>If the bytes do not decode to a <code>NetworkMessage</code> or the <code>peer_id</code> has no entry in the <code>peer_state</code> map, report and ignore.</li>
<li>If this is <code>NetworkMessage::Awaiting(relay_parent, pov_hashes)</code>:
<ul>
<li>If there is no entry under <code>peer_state.awaited</code> for the <code>relay_parent</code>, report and ignore.</li>
<li>If <code>relay_parent</code> is not contained within <code>our_view</code>, report and ignore.</li>
<li>Otherwise, if the peer's <code>awaited</code> map combined with the <code>pov_hashes</code> would have more than <code> 2 * relay_parent_state[relay_parent].n_validators</code> entries, report and ignore. Note that we are leaning on the property of the network bridge that it sets our view based on <code>activated</code> heads in <code>ActiveLeavesUpdate</code> signals.</li>
<li>For each new <code>pov_hash</code> in <code>pov_hashes</code>, if there is a <code>pov</code> under <code>pov_hash</code> in the <code>known</code> map, send the peer a <code>NetworkMessage::SendPoV(relay_parent, pov_hash, pov)</code>.</li>
<li>Otherwise, add the <code>pov_hash</code> to the <code>awaited</code> map</li>
</ul>
</li>
<li>If this is <code>NetworkMessage::SendPoV(relay_parent, pov_hash, pov)</code>:
<ul>
<li>If there is no entry under <code>relay_parent</code> in <code>relay_parent_state</code> or no entry under <code>pov_hash</code> in our <code>fetching</code> map for that <code>relay_parent</code>, report and ignore.</li>
<li>If the blake2-256 hash of the pov doesn't equal <code>pov_hash</code>, report and ignore.</li>
<li>Complete and remove any listeners in the <code>fetching</code> map under <code>pov_hash</code>. However, leave an empty set of listeners in the <code>fetching</code> map to denote that this was something we once awaited. This will allow us to recognize peers who have sent us something we were expecting, but just a little late.</li>
<li>Add to <code>known</code> map.</li>
<li>Remove the <code>pov_hash</code> from the <code>peer.awaited</code> map, if any.</li>
<li>Send <code>NetworkMessage::SendPoV(relay_parent, descriptor.pov_hash, PoV)</code> to all peers who have the <code>descriptor.pov_hash</code> in the set under <code>relay_parent</code> in the <code>peer.awaited</code> map and remove the entry from <code>peer.awaited</code>.</li>
</ul>
</li>
</ul>
</li>
<li>On <code>PeerViewChange(peer_id, view)</code>
<ul>
<li>If Peer is unknown, ignore.</li>
<li>Ensure there is an entry under <code>relay_parent</code> for each <code>relay_parent</code> in <code>view</code> within the <code>peer.awaited</code> map, creating blank <code>awaited</code> lists as necessary.</li>
<li>Remove all entries under <code>peer.awaited</code> that are not within <code>view</code>.</li>
<li>For all hashes in <code>view</code> but were not within the old, send the peer all the keys in our <code>fetching</code> map under the block-based state for that hash - i.e. notify the peer of everything we are awaiting at that hash.</li>
</ul>
</li>
<li>On <code>OurViewChange(view)</code>
<ul>
<li>Update <code>our_view</code> to <code>view</code></li>
</ul>
</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="../../node/backing/statement-distribution.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="../../node/availability/index.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="../../node/backing/statement-distribution.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a rel="next" href="../../node/availability/index.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="../../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="../../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
